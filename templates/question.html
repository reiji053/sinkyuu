<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>問題画面</title>
    <link rel="stylesheet" href="/static/styles.css?v=2" />
  </head>

  <body>
    {% if finished %}

    <!-- ================= Result画面 ================= -->
    <div class="question result-page">
      <h1>Result</h1>

      <div class="result-score">
        <span class="score-correct">{{ correct }}</span>
        <span class="score-slash">/</span>
        <span class="score-total">{{ total }}</span>
      </div>

      <div class="result-buttons">
        <a
          href="{{ url_for('question', genre=genre, level=level, reset=1) }}"
          class="answer-submit result-btn"
        >
          Try Again
        </a>

        <a href="/select" class="answer-submit result-btn"> Select Stage </a>
      </div>
    </div>

    {% else %}

    <!-- ================= 問題画面 ================= -->
    <div class="question" data-correct-id="{{ question.correct_choice_id }}">
      <h1 class="question-number">Q{{ question.number }}</h1>

      <div class="question-box">
        <p class="question-text">{{ question.question_text }}</p>

        {% if question.image_url %}
        <img
          src="{{ question.image_url }}"
          alt="question image"
          class="question-image"
        />
        {% endif %}
      </div>

      {% for choice in choices %}
      <a class="answer-btn" href="#" data-choice-id="{{ choice.id }}">
        <h2>{{ choice.choice_text }}</h2>
      </a>
      {% endfor %}

      <button id="answerBtn" class="answer-submit disabled" disabled>
        Answer
      </button>

      <!-- ===== 正解 / 不正解 表示 ===== -->
      <div id="resultBox" class="result-box hidden">
        <span id="resultText" class="result-text"></span>

        <div class="result-actions">
          <button
            type="button"
            id="explanationBtn"
            class="result-btn explanation-btn"
          >
            Explanation
          </button>

          <form method="post">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="question_id" value="{{ question.id }}" />
            <input
              type="hidden"
              name="is_correct"
              id="isCorrectInput"
              value=""
            />
            <button type="submit" class="result-btn next-btn">
              Next Stage
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- ================= Explanation Modal ================= -->
    <div id="explainModal" class="explain-modal hidden">
      <div class="explain-modal-content">
        <h2>Explanation</h2>
        <p id="explainText">{{ question.explanation }}</p>

        <div class="explain-footer">
          <button id="closeExplain" class="explain-close-btn">close</button>
        </div>
      </div>
    </div>

    <!-- ================= JavaScript ================= -->
    <script>
      const buttons = document.querySelectorAll(".answer-btn");
      const answerBtn = document.getElementById("answerBtn");
      const resultBox = document.getElementById("resultBox");
      const resultText = document.getElementById("resultText");
      const correctId = document.querySelector(".question").dataset.correctId;

      const explanationBtn = document.getElementById("explanationBtn");
      const explainModal = document.getElementById("explainModal");
      const closeExplain = document.getElementById("closeExplain");
      const isCorrectInput = document.getElementById("isCorrectInput");

      let selectedId = null;
      let answered = false;

      /* 選択 */
      buttons.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          if (answered) return;

          buttons.forEach((b) => b.classList.remove("selected"));
          btn.classList.add("selected");

          selectedId = btn.dataset.choiceId;
          answerBtn.disabled = false;
          answerBtn.classList.remove("disabled");
        });
      });

      /* 回答 */
      answerBtn.addEventListener("click", () => {
        if (answered || !selectedId) return;
        answered = true;

        resultBox.classList.remove("hidden", "correct", "wrong");

        buttons.forEach((btn) => {
          const id = btn.dataset.choiceId;

          btn.classList.remove("correct", "wrong");

          if (id === correctId) {
            btn.classList.add("correct");
          } else if (id === selectedId) {
            btn.classList.add("wrong");
          }

          btn.style.pointerEvents = "none";
        });

        if (selectedId === correctId) {
          resultText.textContent = "正解！";
          resultBox.classList.add("correct");
          isCorrectInput.value = "1";
        } else {
          resultText.textContent = "不正解！";
          resultBox.classList.add("wrong");
          isCorrectInput.value = "0";
        }

        answerBtn.disabled = true;
      });

      /* Explanation modal */
      explanationBtn.addEventListener("click", () => {
        explainModal.classList.remove("hidden");
      });

      closeExplain.addEventListener("click", () => {
        explainModal.classList.add("hidden");
      });
    </script>
      {% include "_bottom_nav.html" %}

    {% endif %}
  </body>
</html>

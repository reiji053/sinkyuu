<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>問題画面</title>
    <link rel="stylesheet" href="/static/styles.css?v=2" />
  </head>

  <body>
    {% if finished %}

    <!-- ================= Result画面 ================= -->
    <div class="question result-page">
      <h1>Result</h1>

      <div class="result-score">
        <span class="score-correct">{{ correct }}</span>
        <span class="score-slash">/</span>
        <span class="score-total">{{ total }}</span>
      </div>

      <div class="result-buttons">
        <a
          href="{{ url_for('question', genre=genre, level=level, reset=1) }}"
          class="answer-submit result-btn"
        >
          Try Again
        </a>

        <a href="/select" class="answer-submit result-btn"> Select Stage </a>
      </div>
    </div>

    {% else %}

    <!-- ================= 問題画面 ================= -->
    <div class="question" data-correct-id="{{ question.correct_choice_id }}">
      <h1 class="question-number">Q{{ question.number }}</h1>

      <div class="question-box">
        <p class="question-text">{{ question.question_text }}</p>

        {% if question.image_url %}
        <img
          id="questionImage"
          src="{{ question.image_url | safe }}"
          alt="question image"
          class="question-image"
        />
        {% endif %}
      </div>

      {% for choice in choices %}
      <a class="answer-btn" href="#" data-choice-id="{{ choice.id }}">
        <h2>{{ choice.choice_text }}</h2>
      </a>
      {% endfor %}

      <!-- ===== 正解 / 不正解 表示 ===== -->
      <div id="resultBox" class="result-box hidden">
        <span id="resultText" class="result-text"></span>

        <div class="result-actions">
          <button
            type="button"
            id="explanationBtn"
            class="result-btn explanation-btn"
          >
            Explanation
          </button>

          <form method="post">
            <input
              type="hidden"
              name="_csrf_token"
              value="{{ csrf_token() }}"
            />
            <input type="hidden" name="question_id" value="{{ question.id }}" />
            <input
              type="hidden"
              name="is_correct"
              id="isCorrectInput"
              value=""
            />
            <button type="submit" class="result-btn next-btn">
              Next Stage
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- ================= Explanation Modal ================= -->
    <div id="explainModal" class="explain-modal hidden">
      <div class="explain-modal-content">
        <h2>Explanation</h2>
        <p id="explainText">{{ question.explanation }}</p>

        <div class="explain-footer">
          <button id="closeExplain" class="explain-close-btn">close</button>
        </div>
      </div>
    </div>

    <!-- ================= JavaScript ================= -->
    <script>
      const correctImageBase64 = "{{ correct_image | safe }}";
      const wrongImageBase64 = "{{ wrong_image | safe }}";
      const questionImage = document.getElementById("questionImage");

      const questionEl = document.querySelector(".question");

      const buttons = Array.from(questionEl.querySelectorAll(".answer-btn"));

      // ===== ランダム化 =====
      for (let i = buttons.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [buttons[i], buttons[j]] = [buttons[j], buttons[i]];
      }

      buttons.forEach((btn) => questionEl.appendChild(btn));

      const resultBox = document.getElementById("resultBox");
      const resultText = document.getElementById("resultText");
      const correctId = document.querySelector(".question").dataset.correctId;

      const explanationBtn = document.getElementById("explanationBtn");
      const explainModal = document.getElementById("explainModal");
      const closeExplain = document.getElementById("closeExplain");
      const isCorrectInput = document.getElementById("isCorrectInput");

      let answered = false;

      /* 選択 */
      buttons.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          if (answered) return;

          answered = true;
          const selectedId = btn.dataset.choiceId;

          resultBox.classList.remove("hidden", "correct", "wrong");

          buttons.forEach((b) => {
            const id = b.dataset.choiceId;
            b.classList.remove("correct", "wrong", "selected");

            if (id === correctId) {
              b.classList.add("correct");
            } else if (id === selectedId) {
              b.classList.add("wrong");
            }

            b.style.pointerEvents = "none";
          });

          if (selectedId === correctId) {
            resultText.textContent = "Correct！";
            resultBox.classList.add("correct");
            isCorrectInput.value = "1";

            if (questionImage && correctImageBase64) {
              questionImage.src = correctImageBase64;
            }
          } else {
            resultText.textContent = "Incorrect！";
            resultBox.classList.add("wrong");
            isCorrectInput.value = "0";

            if (questionImage && wrongImageBase64) {
              questionImage.src = wrongImageBase64;
            }
          }
        });
      });

      /* Explanation modal */
      explanationBtn.addEventListener("click", () => {
        explainModal.classList.remove("hidden");
      });

      closeExplain.addEventListener("click", () => {
        explainModal.classList.add("hidden");
      });
    </script>
    {% include "_bottom_nav.html" %} {% endif %}
  </body>
</html>
